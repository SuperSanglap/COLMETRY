<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Coloroid</title>
    <link rel="stylesheet" href="CSS/style.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/js/all.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
</head>

<body>
    <div class="game-container">
        <canvas id="game"></canvas>

        <div class="hud-layer">
            <div class="hud-left">
                <div class="chip"><span id="uiScore">0</span> <span class="small">Score</span></div>
                <div class="chip hearts" id="uiLives"></div>
            </div>
            <div class="hud-right">
                <div class="chip">
                    <span class="dot" id="uiCurrDot"></span>
                    <span id="uiCurrName"></span>
                </div>
                <div class="chip"><span id="uiTimer"></span> <span class="small">Swap</span></div>
            </div>
        </div>

        <div class="hud-layer" style="top:84px">
            <div class="chip" id="powerupBar">
                <span id="pwrShield" title="Shield Powerup">üõ°Ô∏è</span>
                <span id="pwrClock" title="Clock Powerup">‚è∞</span>
                <span id="pwrMagnet" title="Magnet Powerup">üß≤</span>
            </div>
        </div>

        <div class="game-btn-row">
            <button class="control-btn icon-btn" id="btnMusic" title="Music">
                <!-- Use Font Awesome volume icon; default to muted (xmark) until user enables -->
                <i id="iconMusic" class="fa-solid fa-volume-xmark" aria-hidden="true"></i>
            </button>
            <button class="control-btn icon-btn" id="btnPause" title="Pause/Play">
                <i id="faPause" class="fa-solid fa-pause"></i>
                <i id="faPlay" class="fa-solid fa-play" style="display:none;"></i>
            </button>
            <button class="control-btn icon-btn" id="btnRetry" title="Retry">
                <i id="iconRetry" class="fa-solid fa-rotate-right"></i>
            </button>
        </div>

    <audio id="bgm" loop src="SFX/bgm.mp3"></audio>

        <div class="overlay" id="overlay">
            <div class="card">
                <div id="overlayText"></div>
                <div class="overlay-btn-row">
                    <button class="control-btn icon-btn" id="btnOverlayRestart" title="Restart">
                        <i class="fa-solid fa-rotate-right fa-2x"></i>
                    </button>
                    <button class="control-btn icon-btn" id="btnOverlayHome" title="Home">
                        <i class="fa-solid fa-house fa-xl"></i>
                    </button>
                </div>
            </div>
        </div>
        <!-- Start Screen Overlay -->
    <div class="overlay start-overlay" id="tutorialOverlay" style="display:flex;">
        <canvas id="startBgCanvas" class="start-bg-canvas"></canvas>
        <div class="start-content">
            <div class="start-header">
                <div class="start-orbs" aria-hidden="true">
                    <span class="orb o1"></span>
                    <span class="orb o2"></span>
                    <span class="orb o3"></span>
                    <span class="orb o4"></span>
                </div>
                <div id="coloroidTitle" class="game-title">Coloroid</div>
                <div class="subtitle">fast reflexes ‚Ä¢ color matching ‚Ä¢ powerups</div>
            </div>

            <div class="card start-card">
                <h2>How to Play</h2>
                <ul class="howto">
                    <li>Move the mouse to control the paddle.</li>
                    <li>Hold <b>left mouse button</b> to shrink the paddle for precision.</li>
                    <li>Catch orbs matching the current color for points.</li>
                    <li>Avoid wrong colors, collect powerups, and survive!</li>
                </ul>
                <button id="startBtn" class="start-cta">Play Now</button>
            </div>
        </div>
        <!-- Falling decorative elements container -->
        <div class="fall-container" aria-hidden="true">
            <div class="fall c1"></div>
            <div class="fall c2"></div>
            <div class="fall c3"></div>
            <div class="fall c4"></div>
            <div class="fall c5"></div>
            <!-- New shapes -->
            <div class="fall star"></div>
            <div class="fall square"></div>
        </div>
    </div>

    <script>
    // Make the start overlay click-safe: only the Play Now button starts the game.
    (function(){
        // Centralized control show/hide helpers (exposed globally)
        window.showControls = function(){
            try{ var gb = document.querySelector('.game-btn-row'); if (gb){ gb.style.display = 'flex'; gb.style.pointerEvents = 'auto'; gb.style.opacity = ''; } }catch(e){}
        };
        window.hideControls = function(){
            try{ var gb = document.querySelector('.game-btn-row'); if (gb){ gb.style.display = 'none'; gb.style.pointerEvents = 'none'; } }catch(e){}
        };
        var overlay = document.getElementById('tutorialOverlay');
        var startBtn = document.getElementById('startBtn');
        // Only prevent clicks that target the overlay background itself.
        // This lets interactive children (buttons/links) receive events normally.
        if(overlay){
            overlay.addEventListener('click', function(e){
                if(e.target === overlay) {
                    e.stopPropagation();
                }
            });
        }

        // Start game only when Play Now is clicked
        if(startBtn){
            startBtn.addEventListener('click', function(e){
                // prevent bubbling but don't block other handlers on the button
                e.stopPropagation();
                // hide overlay visually and remove it so nothing blocks input
                if (overlay) {
                    overlay.style.display = 'none';
                    try { overlay.style.pointerEvents = 'none'; } catch(e){}
                    if (overlay.parentNode) overlay.parentNode.removeChild(overlay);
                    // unlock home so capture blockers allow game input
                    try{ window._homeLocked = false; }catch(e){}
                }
                // re-enable game container pointer events so canvas receives input
                var gameContainer = document.querySelector('.game-container');
                if (gameContainer) gameContainer.style.pointerEvents = '';
                // request fullscreen for immersive play (if available)
                if (document.documentElement.requestFullscreen) {
                    document.documentElement.requestFullscreen().catch(()=>{});
                } else if (document.documentElement.webkitRequestFullscreen) {
                    document.documentElement.webkitRequestFullscreen();
                }
                // hide footer credit during play
                var foot = document.querySelector('.footer-credit'); if (foot) foot.style.display = 'none';
                // show control buttons now that we're leaving the start screen
                showControls();
                // restore UI buttons (make sure pause/retry work and styles reset)
                if (typeof window._restoreUIButtons === 'function') window._restoreUIButtons();
                // call game starter if available
                try{
                    if(typeof window.startColoroidGame === 'function') window.startColoroidGame();
                    else if(typeof window.startGame === 'function') window.startGame();
                }catch(err){
                    console.warn('start button pressed, but start function not found', err);
                }
                // Start BGM (allowed because Play button is a user gesture). Set user preference to on.
                try{
                    var bgmEl = document.getElementById('bgm');
                    var iconMusic = document.getElementById('iconMusic');
                    if (bgmEl && bgmEl.src) {
                        bgmEl.play().then(function(){
                            window._bgmUserOn = true;
                            if (iconMusic) { iconMusic.classList.remove('fa-volume-xmark','fa-volume-off'); iconMusic.classList.add('fa-volume-high'); }
                        }).catch(function(err){
                            // Playback blocked by browser/autoplay policy or other issue
                            console.warn('BGM play blocked or failed', err);
                            window._bgmUserOn = false;
                            if (iconMusic) { iconMusic.classList.remove('fa-volume-high'); iconMusic.classList.add('fa-volume-xmark'); }
                        });
                    }
                }catch(e){}
            });
        }
    })();
    </script>

    <script>
    // Extra protection: while the tutorial overlay is visible, block any clicks that are not
    // the Play button or the footer credit. This uses a capturing listener so it runs before
    // other handlers (including any engine-attached click-to-play). It won't interfere once
    // the overlay is hidden or removed.
    (function(){
        var overlay = document.getElementById('tutorialOverlay');
        if (!overlay) return;
        document.addEventListener('click', function(e){
            try{
                var disp = window.getComputedStyle(overlay).display;
                if (disp === 'none' || disp === '') return; // overlay not visible
                // allow Play button and footer credit clicks to proceed
                if (e.target.closest && (e.target.closest('#startBtn') || e.target.closest('.footer-credit') || e.target.closest('#credit-link'))) return;
                // otherwise block the event from reaching other listeners (engine)
                e.stopImmediatePropagation();
                e.preventDefault();
            }catch(err){ /* fail safely */ }
        }, true); // use capture phase
    })();
    </script>

        <!-- Mobile Block Overlay -->
        <div class="overlay" id="mobileOverlay" style="display:none;">
            <div class="card">
                <h2>PC Only</h2>
                <p>This game is designed for desktop/laptop computers.<br>Please open on a PC for the best experience.</p>
            </div>
        </div>

        <!-- Footer credit -->
        <div class="footer-credit" style="position:fixed;left:0;right:0;bottom:8px;z-index:1010;pointer-events:auto;display:flex;justify-content:center;">
            <div class="credit small" style="padding:6px 10px;background:rgba(8,12,18,0.6);border-radius:8px;border:1px solid rgba(255,255,255,0.04);">
                Made with <span style="color:#ff5b6e;margin:0 6px;">‚ô•</span> by <a id="credit-link" href="https://github.com/SuperSanglap" target="_blank" rel="noopener noreferrer">Sanglap</a>
            </div>
        </div>

        <script>
        // Prevent clicks on the credit link from starting the game (stop propagation)
        (function(){
            var link = document.getElementById('credit-link');
            if(link){
                link.addEventListener('click', function(e){
                    e.stopPropagation();
                    // allow normal link behavior (opening in new tab)
                });
            }
            var creditBox = document.querySelector('.footer-credit');
            if(creditBox){
                creditBox.addEventListener('click', function(e){
                    e.stopPropagation();
                });
            }
        })();
        </script>
    </div>

    <script src="JS/script.js"></script>
    <script>
    // After engine script loads, remove any click-to-play listener attached by the engine
    // by cloning the overlay node (cloning removes event listeners). Then reattach
    // a dedicated Play button handler so only the Play Now button starts the game.
    (function(){
        try{
            var old = document.getElementById('tutorialOverlay');
            if(old && old.parentNode){
                var clone = old.cloneNode(true);
                // preserve inline styles
                clone.style.display = old.style.display;
                old.parentNode.replaceChild(clone, old);
                // rewire start button on cloned overlay
                var startBtn = clone.querySelector('#startBtn');
                if(startBtn){
                    startBtn.addEventListener('click', function(e){
                        e.stopPropagation();
                        // hide and remove the cloned overlay so it can't block input
                        clone.style.display = 'none';
                        try { clone.style.pointerEvents = 'none'; } catch(e){}
                        if (clone.parentNode) clone.parentNode.removeChild(clone);
                        // unlock home so capture blockers allow game input
                        try{ window._homeLocked = false; }catch(e){}
                        var gameContainer = document.querySelector('.game-container');
                        if (gameContainer) gameContainer.style.pointerEvents = '';
                        if (document.documentElement.requestFullscreen) {
                            document.documentElement.requestFullscreen().catch(()=>{});
                        } else if (document.documentElement.webkitRequestFullscreen) {
                            document.documentElement.webkitRequestFullscreen();
                        }
                        // hide footer credit during play
                        var foot = document.querySelector('.footer-credit'); if (foot) foot.style.display = 'none';
                        // show control buttons now that we're leaving the start screen
                        showControls();
                        // restore UI buttons so pause/retry are active
                        if (typeof window._restoreUIButtons === 'function') window._restoreUIButtons();
        }catch(err){ console.warn('overlay clone failed', err); }
    })();
    </script>
    <script src="JS/main.js"></script>
    <script>
    // Ensure UI buttons (pause/retry/music/overlay) are bound and visually reset when the game starts.
    (function(){
        function ensure(id, evt, fn) {
            var el = document.getElementById(id);
            if (!el) return;
            // Remove duplicate listeners by cloning if necessary
            try { el.replaceWith(el.cloneNode(true)); } catch(e) {}
            el = document.getElementById(id);
            if (el) el.addEventListener(evt, fn);
        }

        window._restoreUIButtons = function() {
            // Re-bind handlers present in JS/main.js if not bound
            try{
                // Pause button
                ensure('btnPause','click', function(){ if (window.togglePause) window.togglePause(); if (window.syncPlayPauseIcon) window.syncPlayPauseIcon(); });
                // Retry
                ensure('btnRetry','click', function(){ if (window.restart) window.restart(); });
                // Overlay restart
                ensure('btnOverlayRestart','click', function(){ if (window.restart) window.restart(); });
                // Music toggle: use audio element's paused state and update icon
                ensure('btnMusic','click', function(){
                    var bgmEl = document.getElementById('bgm');
                    var iconMusic = document.getElementById('iconMusic');
                    if (!bgmEl) return;
                    if (!bgmEl.src) {
                        alert('No music source set. Add a file URL to the <audio> element src attribute in the code to enable music.');
                        return;
                    }
                    if (bgmEl.paused) {
                        bgmEl.play().catch(()=>{});
                        if (iconMusic) { iconMusic.classList.remove('fa-volume-xmark','fa-volume-off'); iconMusic.classList.add('fa-volume-high'); }
                    } else {
                        bgmEl.pause();
                        if (iconMusic) { iconMusic.classList.remove('fa-volume-high'); iconMusic.classList.add('fa-volume-off'); }
                    }
                });
                // Reset visual state: ensure play/pause icon synced
                if (typeof window.syncPlayPauseIcon === 'function') window.syncPlayPauseIcon();
                // Reset small transforms (retry icon)
                var iconRetry = document.getElementById('iconRetry'); if (iconRetry) { iconRetry.style.transform = ''; iconRetry.style.transition = ''; }
                // Ensure control buttons look active (remove dimming)
                var controls = document.querySelectorAll('.game-btn-row .control-btn');
                controls.forEach(c => { c.style.opacity = ''; c.style.pointerEvents = ''; });
                // Ensure the canvas and game container accept pointer events
                try{
                    var gameCanvas = document.getElementById('game');
                    if (gameCanvas) { gameCanvas.style.pointerEvents = 'auto'; gameCanvas.style.zIndex = 0; }
                    var gameContainer = document.querySelector('.game-container');
                    if (gameContainer) gameContainer.style.pointerEvents = '';
                }catch(e){}
                // Hide footer credit while game is active
                try {
                    var foot = document.querySelector('.footer-credit');
                    if (foot) {
                        // Only hide the footer if the game has actually started. If we're on the home screen
                        // keep the credit visible.
                        if (window.started) foot.style.display = 'none'; else foot.style.display = 'flex';
                    }
                } catch(e){}
            }catch(e){ console.warn('restore UI buttons failed', e); }
        };

        // Call once in case game already started
        window.addEventListener('load', function(){ setTimeout(function(){ if (typeof window._restoreUIButtons === 'function') window._restoreUIButtons(); }, 60); });
        // Observe the main overlay (#overlay) and re-show the footer credit when overlay becomes visible (e.g., game over)
        (function(){
            try{
                var overlayMain = document.getElementById('overlay');
                var foot = document.querySelector('.footer-credit');
                if (!overlayMain || !foot) return;
                var mo = new MutationObserver(function(m){
                    m.forEach(function(rec){
                        if (rec.attributeName === 'class' || rec.attributeName === 'style'){
                            var disp = window.getComputedStyle(overlayMain).display;
                            if (disp === 'flex' || disp === 'block') {
                                foot.style.display = '';
                                try { if (typeof window.syncPlayPauseIcon === 'function') window.syncPlayPauseIcon(); } catch(e){}
                            } else {
                                // overlay hidden -> ensure icons reflect running state
                                try { if (typeof window.syncPlayPauseIcon === 'function') window.syncPlayPauseIcon(); } catch(e){}
                            }
                        }
                    });
                });
                mo.observe(overlayMain, { attributes: true, attributeFilter: ['class','style'] });
            }catch(e){}
        })();
    })();
    </script>
    <script>
    // Hide control buttons on initial load (home screen). They'll be shown when Play is clicked.
    (function(){
        try{
            hideControls();
        }catch(e){}
    })();

    // Block pointer gestures while start overlay is visible (capture phase)
    (function(){
        var overlay = document.getElementById('tutorialOverlay');
        if (!overlay) return;
        function blocker(e){
            try{
                var disp = window.getComputedStyle(overlay).display;
                if (disp === 'none' || disp === '') return;
                if (e.target.closest && (e.target.closest('#startBtn') || e.target.closest('.footer-credit') || e.target.closest('#credit-link'))) return;
                e.stopImmediatePropagation(); e.preventDefault();
            }catch(err){}
        }
        document.addEventListener('pointerdown', blocker, true);
        document.addEventListener('mousedown', blocker, true);
        document.addEventListener('touchstart', blocker, true);
    })();

    // Robust restart wrapper: wrap existing restart or wait and wrap; ensure syncPlayPauseIcon runs after restart
    (function(){
        function wrapRestart(){
            try{
                if (typeof window.restart === 'function' && !window._restartWrapped){
                    var orig = window.restart;
                    window.restart = function(){
                        var res = orig.apply(this, arguments);
                        try{ if (typeof window.syncPlayPauseIcon === 'function') window.syncPlayPauseIcon(); } catch(e){}
                        try{ var bgm = document.getElementById('bgm'); if (window._bgmUserOn && bgm && bgm.src) { bgm.play().catch(()=>{}); var iconMusic = document.getElementById('iconMusic'); if (iconMusic) { iconMusic.classList.remove('fa-volume-xmark','fa-volume-off'); iconMusic.classList.add('fa-volume-high'); } } } catch(e){}
                        return res;
                    };
                    window._restartWrapped = true;
                    return true;
                }
            }catch(e){ }
            return false;
        }
        if (!wrapRestart()){
            // try again until restart appears (engine may attach later)
            var t = setInterval(function(){ if (wrapRestart()){ clearInterval(t); } }, 120);
        }
    })();
    </script>
    <script>
    // Debug helper: periodically spawn a visible powerup orb so the user can see powerups falling.
    // This is non-invasive: it uses the existing global spawnOrb function and only runs during play.
    (function(){
        try{
            // Toggle this to false to disable the debug spawns
            window._debugSpawnPowerups = true;
            function spawnDebugPowerup(){
                if (!window._debugSpawnPowerups) return;
                if (typeof spawnOrb !== 'function') return;
                // only spawn while game has started and not game over
                if (!window.started || window.gameOver) return;
                // don't spam: keep at most 1 debug powerup on screen
                try{
                    var existing = (window.orbs || []).filter(o => o.isPowerup).length;
                    if (existing > 1) return;
                }catch(e){}
                var types = ['shield','clock','magnet'];
                var t = types[Math.floor(Math.random() * types.length)];
                var W = window.innerWidth || 800;
                var x = Math.max(40, Math.min(W - 40, Math.floor(Math.random() * (W - 80)) + 40));
                try{ spawnOrb({ isPowerup: true, powerupType: t, x: x }); }catch(e){}
            }
            // Spawn every ~8 seconds while playing
            setInterval(spawnDebugPowerup, 8000);
        }catch(e){ console.warn('debug powerup injector failed', e); }
    })();
    </script>
    <script>
    // Monkey-patch restart: ensure syncPlayPauseIcon is called whenever restart runs
    (function(){
        try{
            if (typeof window.restart === 'function') {
                var orig = window.restart;
                window.restart = function(){
                    var res = orig.apply(this, arguments);
                    try{ if (typeof window.syncPlayPauseIcon === 'function') window.syncPlayPauseIcon(); } catch(e){}
                    return res;
                };
            } else {
                // If restart is not yet defined, attach a safe wrapper to call sync when it becomes available
                var _check = setInterval(function(){
                    if (typeof window.restart === 'function'){
                        clearInterval(_check);
                        var orig2 = window.restart;
                        window.restart = function(){
                            var res = orig2.apply(this, arguments);
                            try{ if (typeof window.syncPlayPauseIcon === 'function') window.syncPlayPauseIcon(); } catch(e){}
                            return res;
                        };
                    }
                }, 120);
            }
        }catch(e){ console.warn('restart wrapper failed', e); }
    })();
    </script>
</body>

</html>